# OpenVPN UFW Rule Generator

Automatizovaný skript pro generování a správu **UFW (Uncomplicated Firewall) pravidel** pro OpenVPN server, včetně řízení přístupu jednotlivých klientů, izolace i trvalého nebo časového zákazu.
**Ideální pro prostředí, kde chcete mít správu přístupu pod kontrolou, včetně auditu a automatizace.**

## Funkce skriptu

* **Načítá konfigurační soubor se seznamem klientů (ve formátu JSON/JSONC/JS s komentáři)**
* **Automaticky validuje IP adresy klientů i serveru**
* **Kontroluje duplicitu IP adres**
* **Podporuje následující typy klientů:**

  * `0` – žádné omezení (běžný provoz)
  * `1` – BAN (trvalý nebo dočasný, možnost nastavit datum ukončení banu)
  * `2` – Izolace (klient smí komunikovat jen se serverem, ne s ostatními klienty)
* **Podpora pole `created` (datum vytvoření pravidla/klienta) a volitelného pole `comment` (poznámka)**
* **Každá změna je jasně auditovatelná, generuje se komentář se jménem autora, verzí skriptu a datem**
* **Výstup je zapsán do předem určeného bloku v `/etc/ufw/before.rules`**
* **Automatická záloha původního konfiguračního souboru UFW před úpravou**
* **Všechny změny jsou okamžitě aktivní po `ufw reload`**

## Struktura konfiguračního souboru

Konfigurační soubor obsahuje sekci s popisem (lze použít pro IDE nebo lintování) a vlastní JSON s konfigurací:

```js
/**
 * Popis struktury viz JB doc.
 */
/** @type {jb_ufw_vpn_cfg} */
// BOF JSON CFG
{
    "server_name": "openvpn-jb",
    "server_ip": "10.8.0.1",
    "server_mask": 23,
    "clients": [
        {
            "clientName": "Pavel Petr",
            "clientIP": "10.8.0.12",
            "created": "2025-08-01 11:10:20",
            "type": 2
        },
        {
            "clientName": "Karel Nový",
            "clientIP": "10.8.0.8",
            "created": "2025-08-01 11:10:20",
            "type": 2
        },
        {
            "clientName": "Jan Nový",
            "clientIP": "10.8.0.28",
            "created": "2025-08-01 11:10:20",
            "type": 0
        },
        {
            "clientName": "Jirka Ukončený",
            "clientIP": "10.8.0.27",
            "created": "2025-08-01 11:10:20",
            "type": 1,
            "banTo": "2026-01-01",
            "comment": "Jirka Ukončený - období ochrany vyřazení IP z provozu - cooldownBan"
        }
    ]
}
```

**Důležité:**

* Pole `clientName`, `clientIP` a `type` jsou povinná.
* `type` = 0 (žádná restrikce), 1 (BAN), 2 (Izolace).
* Volitelné pole `banTo` definuje datum, do kdy má být klient blokován (formát YYYY-MM-DD).
* Pole `created` a `comment` slouží pouze pro audit a komentáře, nejsou povinná.

---

## Princip a logika generování

* **Při běhu skriptu se vygeneruje nový blok pravidel mezi hranice `# *** BOF ...` a `# *** EOF ...` v UFW before.rules**
* **Původní obsah je vždy zálohován s timestampem**
* **Každý klient je validován (formát IP, duplicity, validita typu)**
* **Každé pravidlo obsahuje komentář pro audit a je možné v něm předat i libovolný firemní komentář z pole `comment`**
* **BAN s prošlým datumem (`banTo`) pravidlo negeneruje, zůstává pouze komentář (pro audit)**

---

## Ukázkový výstup v UFW before.rules

```text
# *** BOF OpenVPN JB Config - openvpn-jb 10.8.88.0/23

# - Generated by ufw_opevpn_update_form_cfg_json.py on 2025-08-01 11:14:50
# - Version: 1.0.0
# - Author: Jan Zedník <info@dvestezar.cz>

# --- Pavel Petr (10.8.0.12) - vytvořeno 2025-08-01 11:10:20 - izolace
-A ufw-before-forward -i tun+ -s 10.8.0.12 ! -d 10.8.88.1 -m comment --comment "Pavel Petr - izolace" -j DROP

# --- Karel Nový (10.8.0.8) - vytvořeno 2025-08-01 11:10:20 - izolace
-A ufw-before-forward -i tun+ -s 10.8.0.8 ! -d 10.8.88.1 -m comment --comment "Karel Nový - izolace" -j DROP

# --- Jan Nový (10.8.0.28) - vytvořeno 2025-08-01 11:10:20 - konfigurce clienta vypnuta, tzn. bez omezení

# --- Jirka Ukončený (10.8.0.27) - vytvořeno 2025-08-01 11:10:20 - Jirka Ukončený - období ochrany vyřazení IP z provozu - cooldownBan - BAN do 2026-01-01
-A ufw-before-forward -i tun+ -s 10.8.0.27 -m comment --comment "Jirka Ukončený - období ochrany vyřazení IP z provozu - cooldownBan - BAN do 2026-01-01" -j DROP
-A ufw-before-input -i tun+ -s 10.8.0.27 -m comment --comment "Jirka Ukončený - období ochrany vyřazení IP z provozu - cooldownBan - BAN do 2026-01-01" -j DROP

# *** EOF OpenVPN JB Config - openvpn-jb 10.8.88.0/23
```

## Nasazení a použití

1. **Upravte nebo vygenerujte konfigurační soubor podle šablony výše**
2. Ujistěte se, že skript má práva zápisu do `/etc/ufw/before.rules` (spouštět jako root)
3. Spusťte skript (např. `sudo python3 ufw_opevpn_update_form_cfg_json.py`)
4. Po úspěšném průběhu stačí použít `ufw reload` pro aktivaci změn
   (Skript může obsahovat i přímé zavolání reloadu automaticky)
5. Veškeré změny budou zálohovány a je možné je kdykoli auditovat

## Požadavky

* Python 3.7+ (kvůli type hintům)
* Práva zápisu do konfiguračního souboru UFW
* Základní knihovny: `os`, `json`, `shutil`, `re`, `datetime`, `ipaddress`, případně další standardní Python moduly

## Možnosti rozšíření

* Automatická kontrola vypršení BANů (cron, automatizace)
* Integrace s logovacím nebo notifikačním systémem (email, Slack, …)
* Rozšíření typů klientů (povolení na port, povolení subnet, atd.)
* Webové rozhraní pro generování a správu konfiguračního souboru

## Bezpečnostní poznámka

> Skript vždy nejprve provede **zálohu** před úpravou pravidel.
> Výsledná konfigurace je vždy jasně auditovatelná a změny zpětně dohledatelné (díky timestampům a komentářům).

